// Подсветка BSL с использованием highlight.js
// @ts-ignore
import hljs from 'highlight.js';
import 'highlight.js/styles/default.css';

// Регистрируем язык BSL для highlight.js
(hljs as any).registerLanguage('bsl', function(hljs: any) {
  const KEYWORDS = {
    keyword: 'Процедура Функция КонецПроцедуры КонецФункции Если Тогда Иначе ИначеЕсли КонецЕсли ' +
              'Пока Цикл КонецЦикла Для Каждого Из По ' +
              'Попытка Исключение КонецПопытки ' +
              'Возврат Продолжить Прервать ' +
              'Перем Перейти ВызватьИсключение ' +
              'Истина Ложь Неопределено Null ' +
              'И Или Не ' +
              'Новый СоздатьОбъект ПолучитьОбъект ' +
              'Выполнить ВыполнитьСинхронно ' +
              'Экспорт ' +
              'ЗначениеЗаполнено ТипЗнч Вид Тип ' +
              'ГДЕ РазрешитьЧтение РазрешитьИзменениеЕслиРазрешеноЧтение',
    built_in: 'СтрДлина СтрНайти СтрЗаменить СтрРазделить ' +
               'Число Строка Формат Лев Прав Сред ' +
               'ВРег НРег СокрЛ СокрП СокрЛП ' +
               'ТекущаяДата ТекущаяДатаВремя Год Месяц День ' +
               'Окр Цел Мин Макс СлучайноеЧисло ' +
               'Найти НайтиПоПредставлению ПолучитьИзВременногоХранилища ' +
               'Сообщить Предупреждение Вопрос ОжидатьПрерываниеПользователя ' +
               'ЧтениеОбъектаРазрешено ИзменениеОбъектаРазрешено ' +
               'Добавить УдалитьНепроверяемыеРеквизитыИзМассива ОбработкаПроверкиЗаполнения ' +
               'ОбработкаЗаполнения ПриЗаполненииОграниченияДоступа ПередЗаписью ПриЗаписи ' +
               'ПриКопировании ОбработкаПроведения ОбработкаОтменыПроведения',
    type: 'Строка Число Дата Булево ' +
          'Массив Соответствие Структура ФиксированнаяСтруктура ' +
          'ТаблицаЗначений Запрос РезультатЗапроса ' +
          'ДвоичныеДанные УникальныйИдентификатор'
  };

  return {
    name: 'BSL',
    aliases: ['bsl', '1c'],
    case_insensitive: true,
    keywords: KEYWORDS,
    contains: [
      // Комментарии - ПЕРВЫМИ
      hljs.COMMENT('//', '$', {
        relevance: 0
      }),
      // Строки - ВТОРЫМИ, чтобы не подсвечивать ключевые слова внутри строк
      {
        className: 'string',
        begin: '"',
        end: '"',
        contains: [
          {
            begin: '\\|',
            relevance: 0
          }
        ]
      },
      // Директивы препроцессора (#Если, #Область и т.д.)
      {
        className: 'meta',
        begin: /#(?:Если|ИначеЕсли|Иначе|КонецЕсли|Область|КонецОбласти|Клиент|Сервер|ТолстыйКлиентОбычноеПриложение|ТолстыйКлиентУправляемоеПриложение|ВнешнееСоединение|МобильноеПриложениеКлиент|МобильноеПриложениеСервер|Или|И|Не)\b/i,
        relevance: 10
      },
      // Директивы компиляции (&НаСервере, &НаКлиенте)
      {
        className: 'meta',
        begin: /&[А-Яа-яЁёA-Za-z]+/,
        relevance: 5
      },
      // Числа
      hljs.NUMBER_MODE,
      // Вызовы методов (ИмяОбъекта.Метод или просто Метод())
      {
        className: 'built_in',
        begin: /\b[А-Яа-яЁёA-Za-z_][А-Яа-яЁёA-Za-z0-9_]*\s*\.\s*[А-Яа-яЁёA-Za-z_][А-Яа-яЁёA-Za-z0-9_]*\s*\(/,
        relevance: 5
      },
      // Методы без объекта (например, Добавить, ОбработкаПроверкиЗаполнения)
      {
        className: 'built_in',
        begin: /\b(Добавить|УдалитьНепроверяемыеРеквизитыИзМассива|ОбработкаПроверкиЗаполнения|ОбработкаЗаполнения|ПриЗаполненииОграниченияДоступа|ПередЗаписью|ПриЗаписи|ПриКопировании|ОбработкаПроведения|ОбработкаОтменыПроведения)\s*\(/i,
        relevance: 5
      },
      // Операторы
      {
        className: 'operator',
        begin: /[=<>]+|[+\-*/]|\./
      }
    ]
  };
});

// Функция для подсветки BSL кода
export function highlightBSL(code: string): string {
  try {
    // Очищаем код от HTML-тегов
    let cleanCode = code
      .replace(/<[^>]*>/g, '')
      .replace(/&nbsp;/g, ' ')
      .replace(/&amp;/g, '&')
      .replace(/&lt;/g, '<')
      .replace(/&gt;/g, '>')
      .replace(/&quot;/g, '"')
      .replace(/&#39;/g, "'");
    
    // Применяем подсветку highlight.js
    const result = hljs.highlight(cleanCode, { language: 'bsl' });
    return result.value;
  } catch (error) {
    console.error('Ошибка подсветки синтаксиса:', error);
    // Fallback: просто экранируем HTML
    const cleanCode = code
      .replace(/<[^>]*>/g, '')
      .replace(/&nbsp;/g, ' ')
      .replace(/&amp;/g, '&')
      .replace(/&lt;/g, '<')
      .replace(/&gt;/g, '>')
      .replace(/&quot;/g, '"')
      .replace(/&#39;/g, "'");
    return cleanCode
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/\n/g, '<br>');
  }
}

